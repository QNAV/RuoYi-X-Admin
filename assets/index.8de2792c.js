import{B as ce}from"./index.e11998f6.js";import{c as ve}from"./common.b192c4dc.js";import{C as me,a as fe,b as he,c as be,d as ge,e as Ce,f as ye,g as Fe,h as Re,i as we,j as Te,k as Ne,l as Pe,m as Ie,n as Ee,o as _e,p as xe,q as Ve,r as De,s as Be,t as $e,u as ke,v as Oe,G as Ae,w as Se}from"./GenService.084870b7.js";import{G as Ke,u as Ge}from"./useMutation.f791d2f6.js";import{b2 as Le,j as l,a as u,aS as W,r as F,a4 as G,aO as Me,l as j,bR as je,z as qe,_ as pe,c8 as q,h as He,b0 as p,aE as D,cS as Qe,g as E,F as K,aI as ze,aY as Je,bV as We,bH as Ye,n as Ze,p as H,aQ as Ue,a3 as Xe,c_ as en,c2 as nn,c$ as an,cT as tn,aF as rn}from"./index.02daff6f.js";import{P as Q}from"./index.a80c2ed5.js";import{P as S}from"./index.c088df86.js";import{P as on}from"./Table.61182d03.js";import"./RouteContext.f454e969.js";import"./index.6a0d8091.js";import"./index.46f94348.js";/* empty css              */import"./Tree.e476e27a.js";import"./unstated-next.25fbebd4.js";var ln=["onTableChange","maxLength","formItemProps","recordCreatorProps","rowKey","controlled","defaultValue","onChange","editableFormRef"],un=["record","position","creatorButtonText","newRecordType","parentKey","style"],Y=G.createContext(void 0);function Z(e){var v=e.children,b=e.record,R=e.position,o=e.newRecordType,f=e.parentKey,g=F.exports.useContext(Y);return G.cloneElement(v,u(u({},v.props),{},{onClick:function(){var m=Ze(H().mark(function y(_){var T,I,h,V;return H().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(T=(I=v.props).onClick)===null||T===void 0?void 0:T.call(I,_);case 2:if(V=a.sent,V!==!1){a.next=5;break}return a.abrupt("return");case 5:g==null||(h=g.current)===null||h===void 0||h.addEditRecord(b,{position:R,newRecordType:o,parentKey:f});case 6:case"end":return a.stop()}},y)}));function C(y){return m.apply(this,arguments)}return C}()}))}function z(e){var v,b,R=Me(),o=e.onTableChange,f=e.maxLength;e.formItemProps;var g=e.recordCreatorProps,m=e.rowKey;e.controlled;var C=e.defaultValue;e.onChange;var y=e.editableFormRef,_=j(e,ln),T=je(e.value),I=F.exports.useRef(),h=F.exports.useRef();F.exports.useImperativeHandle(_.actionRef,function(){return I.current});var V=qe(function(){return e.value||C||[]},{value:e.value,onChange:e.onChange}),B=pe(V,2),a=B[0],X=B[1],N=G.useMemo(function(){return typeof m=="function"?m:function(s,n){return s[m]||n}},[m]),L=function(n){if(typeof n=="number"&&!e.name){if(n>=a.length)return n;var t=a&&a[n];return N==null?void 0:N(t,n)}if((typeof n=="string"||n>=a.length)&&e.name){var r=a.findIndex(function(i,d){var c;return(N==null||(c=N(i,d))===null||c===void 0?void 0:c.toString())===(n==null?void 0:n.toString())});return r}return n};F.exports.useImperativeHandle(y,function(){var s=function(r){var i,d;if(r==null)throw new Error("rowIndex is required");var c=L(r),w=[e.name,(i=c==null?void 0:c.toString())!==null&&i!==void 0?i:""].flat(1).filter(Boolean);return(d=h.current)===null||d===void 0?void 0:d.getFieldValue(w)},n=function(){var r,i=[e.name].flat(1).filter(Boolean);if(Array.isArray(i)&&i.length===0){var d,c=(d=h.current)===null||d===void 0?void 0:d.getFieldsValue();return Array.isArray(c)?c:Object.keys(c).map(function(w){return c[w]})}return(r=h.current)===null||r===void 0?void 0:r.getFieldValue(i)};return u(u({},h.current),{},{getRowData:s,getRowsData:n,setRowData:function(r,i){var d,c,w,O;if(r==null)throw new Error("rowIndex is required");var A=L(r),ue=[e.name,(d=A==null?void 0:A.toString())!==null&&d!==void 0?d:""].flat(1).filter(Boolean),de=((c=h.current)===null||c===void 0||(w=c.getFieldsValue)===null||w===void 0?void 0:w.call(c))||{},se=q(de,ue,u(u({},s(r)),i||{}));return(O=h.current)===null||O===void 0?void 0:O.setFieldsValue(se)}})}),F.exports.useEffect(function(){!e.controlled||a.forEach(function(s,n){var t;(t=h.current)===null||t===void 0||t.setFieldsValue(He({},N(s,n),s))},{})},[a,e.controlled]),F.exports.useEffect(function(){if(e.name){var s;h.current=e==null||(s=e.editable)===null||s===void 0?void 0:s.form}},[(v=e.editable)===null||v===void 0?void 0:v.form,e.name]);var P=g||{},ee=P.record,$=P.position,ne=P.creatorButtonText,ae=P.newRecordType,te=P.parentKey,re=P.style,oe=j(P,un),M=$==="top",x=F.exports.useMemo(function(){return f&&f<=(a==null?void 0:a.length)?!1:g!==!1&&l(Z,{record:p(ee,a==null?void 0:a.length,a)||{},position:$,parentKey:p(te,a==null?void 0:a.length,a),newRecordType:ae,children:l(D,u(u({type:"dashed",style:u({display:"block",margin:"10px 0",width:"100%"},re),icon:l(Qe,{})},oe),{},{children:ne||R.getMessage("editableTable.action.add","\u6DFB\u52A0\u4E00\u884C\u6570\u636E")}))})},[g,f,a==null?void 0:a.length]),ie=F.exports.useMemo(function(){return x?M?{components:{header:{wrapper:function(n){var t,r=n.className,i=n.children;return E("thead",{className:r,children:[i,E("tr",{style:{position:"relative"},children:[l("td",{colSpan:0,style:{visibility:"hidden"},children:x}),l("td",{style:{position:"absolute",left:0,width:"100%"},colSpan:(t=_.columns)===null||t===void 0?void 0:t.length,children:x})]})]})}}}}:{tableViewRender:function(n,t){var r,i;return E(K,{children:[(r=(i=e.tableViewRender)===null||i===void 0?void 0:i.call(e,n,t))!==null&&r!==void 0?r:t,x]})}}:{}},[M,x]),k=u({},e.editable),le=ze(function(s,n){var t,r,i;if((t=e.editable)===null||t===void 0||(r=t.onValuesChange)===null||r===void 0||r.call(t,s,n),(i=e.onValuesChange)===null||i===void 0||i.call(e,n,s),e.controlled){var d;e==null||(d=e.onChange)===null||d===void 0||d.call(e,n)}});return((e==null?void 0:e.onValuesChange)||((b=e.editable)===null||b===void 0?void 0:b.onValuesChange)||e.controlled&&(e==null?void 0:e.onChange))&&(k.onValuesChange=le),E(K,{children:[l(Y.Provider,{value:I,children:l(on,u(u(u({search:!1,options:!1,pagination:!1,rowKey:m,revalidateOnFocus:!1},_),ie),{},{tableLayout:"fixed",actionRef:I,onChange:o,editable:u(u({},k),{},{formProps:u({formRef:h},k.formProps)}),dataSource:a,onDataSourceChange:function(n){if(X(n),e.name&&$==="top"){var t,r=q({},[e.name].flat(1).filter(Boolean),n);(t=h.current)===null||t===void 0||t.setFieldsValue(r)}}}))}),e.name?l(Je,{name:[e.name],children:function(n){var t,r,i=We(n,[e.name].flat(1)),d=i==null?void 0:i.find(function(c,w){return!Ye(c,T==null?void 0:T[w])});return d&&T&&(e==null||(t=e.editable)===null||t===void 0||(r=t.onValuesChange)===null||r===void 0||r.call(t,d,i)),null}}):null]})}function U(e){var v=Le.useFormInstance();return e.name?l(W.Item,u(u({style:{maxWidth:"100%"}},e==null?void 0:e.formItemProps),{},{name:e.name,children:l(z,u(u({},e),{},{editable:u(u({},e.editable),{},{form:v})}))})):l(z,u({},e))}U.RecordCreator=Z;const dn=({dataSource:e,handleEdit:v})=>{const b={onSave:async(R,o)=>{const f=R;await v({[f]:o[f]})}};return E(K,{children:[l(Q,{dataSource:e,columns:[me,fe,he,be,ve],editable:b}),l(Ue,{}),l(Q,{columns:[ge,Ce,ye,Fe,Re,we,...(e==null?void 0:e.genType)===Ke.ZIP?[]:[Te]],dataSource:e,editable:b})]})},sn=({dataSource:e,handleEdit:v,loading:b=!1})=>{const[R]=W.useForm(),[o,f]=F.exports.useState([]),g=(o==null?void 0:o.length)>0;return l(U,{toolbar:{actions:g?[l(D,{onClick:()=>f([]),icon:l(Xe,{}),children:"\u53D6\u6D88\u7F16\u8F91"},"cancelEdit"),l(D,{type:"primary",loading:b,icon:l(en,{}),onClick:async()=>{const m=await R.validateFields();await v({columns:Object.keys(m).map(C=>({...m[C],columnId:Number(C)}))}),f([])},children:"\u4FDD\u5B58"},"edit")]:[l(D,{icon:l(nn,{}),type:"primary",onClick:()=>{e&&f(e==null?void 0:e.map(m=>{var C,y;return(y=(C=m==null?void 0:m.columnId)==null?void 0:C.toString())!=null?y:""}))},children:"\u7F16\u8F91"},"edit")]},rowKey:"columnId",ghost:!0,size:"small",scroll:{x:"max-content"},columns:[Ne,Pe,Ie,Ee,_e,xe,Ve,De,Be,$e,ke,Oe],value:e,recordCreatorProps:!1,editable:{form:R,editableKeys:o}})},J={BASE_INFO:"\u57FA\u672C\u4FE1\u606F",FIELD_INFO:"\u5B57\u6BB5\u4FE1\u606F"},Pn=()=>{var C;const e=an(),v=Number((C=e==null?void 0:e.tableId)!=null?C:"0"),[b,R]=F.exports.useState("BASE_INFO"),{data:o,refresh:f}=tn(async()=>await Ae({tableId:v}),{ready:v>0,refreshDeps:[v]}),{mutateAsync:g,isLoading:m}=Ge(async y=>{await Se({tableId:v,businessName:o.info.businessName,functionName:o.info.functionName,className:o.info.className,functionAuthor:o.info.functionAuthor,moduleName:o.info.moduleName,packageName:o.info.packageName,tableComment:o.info.tableComment,tableName:o.info.tableName,columns:o.rows,...y})},{onSuccess:()=>{f(),rn.success("\u4FDD\u5B58\u6210\u529F")}});return l(ce,{children:E(S,{tabs:{activeKey:b,onChange:y=>{R(y)}},children:[l(S.TabPane,{tab:J.BASE_INFO,children:l(dn,{dataSource:o==null?void 0:o.info,handleEdit:g})},"BASE_INFO"),l(S.TabPane,{tab:J.FIELD_INFO,children:l(sn,{dataSource:o==null?void 0:o.rows,handleEdit:g,loading:m})},"FIELD_INFO")]})})};export{Pn as default};
