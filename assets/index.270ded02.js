import{j as l,a as u,r as F,ao as p,aS as ce,l as L,_ as ve,bj as M,h as me,aE as fe,g as E,F as S,bh as he,m as ge,n as q,aD as be,cJ as Ce,cp as ye,cK as Fe,aT as we}from"./index.4a7583d0.js";import{B as Re}from"./index.62272242.js";import{c as Te}from"./common.f54ca4d9.js";import{C as Ne,a as Pe,b as Ie,c as Ee,d as _e,e as xe,f as De,g as Ve,h as Be,i as $e,j as ke,k as Oe,l as Ae,m as Ke,n as Se,o as pe,p as Ge,q as je,r as Le,s as Me,t as qe,u as Je,v as He,G as Qe,w as We}from"./GenService.1f5c2508.js";import{G as ze,u as Ze}from"./useMutation.esm.38207e49.js";import{a as Ue,F as z,w as Xe,r as J,g as Ye,v as en,D as nn}from"./index.1dd6cd73.js";import{P as H}from"./index.09f5e557.js";import{u as an,B as V}from"./index.4fe5dc19.js";/* empty css              */import{P as K}from"./index.dc1867e7.js";import"./index.07882f96.js";import{f as tn}from"./PortalWrapper.7f9fd477.js";import{P as rn}from"./Table.12e3c515.js";import{u as on}from"./useRequest.89fb4399.js";import"./RouteContext.2736af70.js";import"./utils.esm.85bc56f4.js";import"./index.d5be6b4e.js";import"./index.dbef3ab0.js";/* empty css              */import"./Skeleton.fa8c4d67.js";import"./Tree.4351fdb6.js";import"./unstated-next.3c14dab8.js";var ln=["onTableChange","maxLength","formItemProps","recordCreatorProps","rowKey","controlled","defaultValue","onChange","editableFormRef"],un=["record","position","creatorButtonText","newRecordType","parentKey","style"],Z=p.createContext(void 0);function U(e){var v=e.children,g=e.record,w=e.position,o=e.newRecordType,f=e.parentKey,b=F.exports.useContext(Z);return p.cloneElement(v,u(u({},v.props),{},{onClick:function(){var m=ge(q().mark(function y(_){var T,I,h,D;return q().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(T=(I=v.props).onClick)===null||T===void 0?void 0:T.call(I,_);case 2:if(D=a.sent,D!==!1){a.next=5;break}return a.abrupt("return");case 5:b==null||(h=b.current)===null||h===void 0||h.addEditRecord(g,{position:w,newRecordType:o,parentKey:f});case 6:case"end":return a.stop()}},y)}));function C(y){return m.apply(this,arguments)}return C}()}))}function Q(e){var v,g,w=ce(),o=e.onTableChange,f=e.maxLength;e.formItemProps;var b=e.recordCreatorProps,m=e.rowKey;e.controlled;var C=e.defaultValue;e.onChange;var y=e.editableFormRef,_=L(e,ln),T=Xe(e.value),I=F.exports.useRef(),h=F.exports.useRef();F.exports.useImperativeHandle(_.actionRef,function(){return I.current});var D=an(function(){return e.value||C||[]},{value:e.value,onChange:e.onChange}),B=ve(D,2),a=B[0],Y=B[1],N=p.useMemo(function(){return typeof m=="function"?m:function(s,n){return s[m]||n}},[m]),G=function(n){if(typeof n=="number"&&!e.name){if(n>=a.length)return n;var t=a&&a[n];return N==null?void 0:N(t,n)}if((typeof n=="string"||n>=a.length)&&e.name){var r=a.findIndex(function(i,d){var c;return(N==null||(c=N(i,d))===null||c===void 0?void 0:c.toString())===(n==null?void 0:n.toString())});return r}return n};F.exports.useImperativeHandle(y,function(){var s=function(r){var i,d;if(r==null)throw new Error("rowIndex is required");var c=G(r),R=[e.name,(i=c==null?void 0:c.toString())!==null&&i!==void 0?i:""].flat(1).filter(Boolean);return(d=h.current)===null||d===void 0?void 0:d.getFieldValue(R)},n=function(){var r,i=[e.name].flat(1).filter(Boolean);if(Array.isArray(i)&&i.length===0){var d,c=(d=h.current)===null||d===void 0?void 0:d.getFieldsValue();return Array.isArray(c)?c:Object.keys(c).map(function(R){return c[R]})}return(r=h.current)===null||r===void 0?void 0:r.getFieldValue(i)};return u(u({},h.current),{},{getRowData:s,getRowsData:n,setRowData:function(r,i){var d,c,R,O;if(r==null)throw new Error("rowIndex is required");var A=G(r),ue=[e.name,(d=A==null?void 0:A.toString())!==null&&d!==void 0?d:""].flat(1).filter(Boolean),de=((c=h.current)===null||c===void 0||(R=c.getFieldsValue)===null||R===void 0?void 0:R.call(c))||{},se=M(de,ue,u(u({},s(r)),i||{}));return(O=h.current)===null||O===void 0?void 0:O.setFieldsValue(se)}})}),F.exports.useEffect(function(){!e.controlled||a.forEach(function(s,n){var t;(t=h.current)===null||t===void 0||t.setFieldsValue(me({},N(s,n),s))},{})},[a,e.controlled]),F.exports.useEffect(function(){if(e.name){var s;h.current=e==null||(s=e.editable)===null||s===void 0?void 0:s.form}},[(v=e.editable)===null||v===void 0?void 0:v.form,e.name]);var P=b||{},ee=P.record,$=P.position,ne=P.creatorButtonText,ae=P.newRecordType,te=P.parentKey,re=P.style,oe=L(P,un),j=$==="top",x=F.exports.useMemo(function(){return f&&f<=(a==null?void 0:a.length)?!1:b!==!1&&l(U,{record:J(ee,a==null?void 0:a.length,a)||{},position:$,parentKey:J(te,a==null?void 0:a.length,a),newRecordType:ae,children:l(V,u(u({type:"dashed",style:u({display:"block",margin:"10px 0",width:"100%"},re),icon:l(fe,{})},oe),{},{children:ne||w.getMessage("editableTable.action.add","\u6DFB\u52A0\u4E00\u884C\u6570\u636E")}))})},[b,f,a==null?void 0:a.length]),ie=F.exports.useMemo(function(){return x?j?{components:{header:{wrapper:function(n){var t,r=n.className,i=n.children;return E("thead",{className:r,children:[i,E("tr",{style:{position:"relative"},children:[l("td",{colSpan:0,style:{visibility:"hidden"},children:x}),l("td",{style:{position:"absolute",left:0,width:"100%"},colSpan:(t=_.columns)===null||t===void 0?void 0:t.length,children:x})]})]})}}}}:{tableViewRender:function(n,t){var r,i;return E(S,{children:[(r=(i=e.tableViewRender)===null||i===void 0?void 0:i.call(e,n,t))!==null&&r!==void 0?r:t,x]})}}:{}},[j,x]),k=u({},e.editable),le=tn(function(s,n){var t,r,i;if((t=e.editable)===null||t===void 0||(r=t.onValuesChange)===null||r===void 0||r.call(t,s,n),(i=e.onValuesChange)===null||i===void 0||i.call(e,n,s),e.controlled){var d;e==null||(d=e.onChange)===null||d===void 0||d.call(e,n)}});return((e==null?void 0:e.onValuesChange)||((g=e.editable)===null||g===void 0?void 0:g.onValuesChange)||e.controlled&&(e==null?void 0:e.onChange))&&(k.onValuesChange=le),E(S,{children:[l(Z.Provider,{value:I,children:l(rn,u(u(u({search:!1,options:!1,pagination:!1,rowKey:m,revalidateOnFocus:!1},_),ie),{},{tableLayout:"fixed",actionRef:I,onChange:o,editable:u(u({},k),{},{formProps:u({formRef:h},k.formProps)}),dataSource:a,onDataSourceChange:function(n){if(Y(n),e.name&&$==="top"){var t,r=M({},[e.name].flat(1).filter(Boolean),n);(t=h.current)===null||t===void 0||t.setFieldsValue(r)}}}))}),e.name?l(Ye,{name:[e.name],children:function(n){var t,r,i=he(n,[e.name].flat(1)),d=i==null?void 0:i.find(function(c,R){return!en(c,T==null?void 0:T[R])});return d&&T&&(e==null||(t=e.editable)===null||t===void 0||(r=t.onValuesChange)===null||r===void 0||r.call(t,d,i)),null}}):null]})}function X(e){var v=Ue.useFormInstance();return e.name?l(z.Item,u(u({style:{maxWidth:"100%"}},e==null?void 0:e.formItemProps),{},{name:e.name,children:l(Q,u(u({},e),{},{editable:u(u({},e.editable),{},{form:v})}))})):l(Q,u({},e))}X.RecordCreator=U;const dn=({dataSource:e,handleEdit:v})=>{const g={onSave:async(w,o)=>{const f=w;await v({[f]:o[f]})}};return E(S,{children:[l(H,{dataSource:e,columns:[Ne,Pe,Ie,Ee,Te],editable:g}),l(nn,{}),l(H,{columns:[_e,xe,De,Ve,Be,$e,...(e==null?void 0:e.genType)===ze.ZIP?[]:[ke]],dataSource:e,editable:g})]})},sn=({dataSource:e,handleEdit:v,loading:g=!1})=>{const[w]=z.useForm(),[o,f]=F.exports.useState([]),b=(o==null?void 0:o.length)>0;return l(X,{toolbar:{actions:b?[l(V,{onClick:()=>f([]),icon:l(be,{}),children:"\u53D6\u6D88\u7F16\u8F91"},"cancelEdit"),l(V,{type:"primary",loading:g,icon:l(Ce,{}),onClick:async()=>{const m=await w.validateFields();await v({columns:Object.keys(m).map(C=>({...m[C],columnId:Number(C)}))}),f([])},children:"\u4FDD\u5B58"},"edit")]:[l(V,{icon:l(ye,{}),type:"primary",onClick:()=>{e&&f(e==null?void 0:e.map(m=>{var C,y;return(y=(C=m==null?void 0:m.columnId)==null?void 0:C.toString())!=null?y:""}))},children:"\u7F16\u8F91"},"edit")]},rowKey:"columnId",ghost:!0,size:"small",scroll:{x:"max-content"},columns:[Oe,Ae,Ke,Se,pe,Ge,je,Le,Me,qe,Je,He],value:e,recordCreatorProps:!1,editable:{form:w,editableKeys:o}})},W={BASE_INFO:"\u57FA\u672C\u4FE1\u606F",FIELD_INFO:"\u5B57\u6BB5\u4FE1\u606F"},$n=()=>{var C;const e=Fe(),v=Number((C=e==null?void 0:e.tableId)!=null?C:"0"),[g,w]=F.exports.useState("BASE_INFO"),{data:o,refresh:f}=on(async()=>await Qe({tableId:v}),{ready:v>0,refreshDeps:[v]}),{mutateAsync:b,isLoading:m}=Ze(async y=>{await We({tableId:v,businessName:o.info.businessName,functionName:o.info.functionName,className:o.info.className,functionAuthor:o.info.functionAuthor,moduleName:o.info.moduleName,packageName:o.info.packageName,tableComment:o.info.tableComment,tableName:o.info.tableName,columns:o.rows,...y})},{onSuccess:()=>{f(),we.success("\u4FDD\u5B58\u6210\u529F")}});return l(Re,{children:E(K,{tabs:{activeKey:g,onChange:y=>{w(y)}},children:[l(K.TabPane,{tab:W.BASE_INFO,children:l(dn,{dataSource:o==null?void 0:o.info,handleEdit:b})},"BASE_INFO"),l(K.TabPane,{tab:W.FIELD_INFO,children:l(sn,{dataSource:o==null?void 0:o.rows,handleEdit:b,loading:m})},"FIELD_INFO")]})})};export{$n as default};
