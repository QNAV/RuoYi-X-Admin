import{b1 as ce,j as l,a as u,aR as U,r as F,a6 as G,aN as ve,l as j,bQ as me,z as fe,_ as he,c7 as q,h as be,a$ as p,aD as D,cU as ge,g as E,F as S,aH as Ce,aX as ye,bU as Fe,bG as Re,n as we,p as H,aP as Ne,a5 as Te,d0 as Pe,c1 as Ie,d1 as Ee,cV as _e,aE as xe}from"./index.05a43b4e.js";import{B as Ve}from"./index.7cd247c1.js";import{c as De}from"./common.5c188665.js";import{C as Be,a as $e,b as ke,c as Oe,d as Ae,e as Ke,f as Se,g as Ge,h as Le,i as Me,j as je,k as qe,l as pe,m as He,n as Qe,o as ze,p as Je,q as Ue,r as We,s as Xe,t as Ze,u as Ye,v as en,G as nn,w as an}from"./GenService.15d4ff12.js";import{G as tn,u as rn}from"./useMutation.3c90135d.js";import{P as Q}from"./index.467f5b9b.js";import{P as K}from"./index.cdf43f8c.js";import{P as on}from"./Table.f56b6733.js";import"./RouteContext.fab80863.js";import"./index.77c3cb15.js";import"./index.1d070600.js";/* empty css              */import"./Tree.97baade9.js";import"./unstated-next.437338e2.js";var ln=["onTableChange","maxLength","formItemProps","recordCreatorProps","rowKey","controlled","defaultValue","onChange","editableFormRef"],un=["record","position","creatorButtonText","newRecordType","parentKey","style"],W=G.createContext(void 0);function X(e){var v=e.children,b=e.record,R=e.position,o=e.newRecordType,f=e.parentKey,g=F.exports.useContext(W);return G.cloneElement(v,u(u({},v.props),{},{onClick:function(){var m=we(H().mark(function y(_){var N,I,h,V;return H().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(N=(I=v.props).onClick)===null||N===void 0?void 0:N.call(I,_);case 2:if(V=a.sent,V!==!1){a.next=5;break}return a.abrupt("return");case 5:g==null||(h=g.current)===null||h===void 0||h.addEditRecord(b,{position:R,newRecordType:o,parentKey:f});case 6:case"end":return a.stop()}},y)}));function C(y){return m.apply(this,arguments)}return C}()}))}function z(e){var v,b,R=ve(),o=e.onTableChange,f=e.maxLength;e.formItemProps;var g=e.recordCreatorProps,m=e.rowKey;e.controlled;var C=e.defaultValue;e.onChange;var y=e.editableFormRef,_=j(e,ln),N=me(e.value),I=F.exports.useRef(),h=F.exports.useRef();F.exports.useImperativeHandle(_.actionRef,function(){return I.current});var V=fe(function(){return e.value||C||[]},{value:e.value,onChange:e.onChange}),B=he(V,2),a=B[0],Y=B[1],T=G.useMemo(function(){return typeof m=="function"?m:function(s,n){return s[m]||n}},[m]),L=function(n){if(typeof n=="number"&&!e.name){if(n>=a.length)return n;var t=a&&a[n];return T==null?void 0:T(t,n)}if((typeof n=="string"||n>=a.length)&&e.name){var r=a.findIndex(function(i,d){var c;return(T==null||(c=T(i,d))===null||c===void 0?void 0:c.toString())===(n==null?void 0:n.toString())});return r}return n};F.exports.useImperativeHandle(y,function(){var s=function(r){var i,d;if(r==null)throw new Error("rowIndex is required");var c=L(r),w=[e.name,(i=c==null?void 0:c.toString())!==null&&i!==void 0?i:""].flat(1).filter(Boolean);return(d=h.current)===null||d===void 0?void 0:d.getFieldValue(w)},n=function(){var r,i=[e.name].flat(1).filter(Boolean);if(Array.isArray(i)&&i.length===0){var d,c=(d=h.current)===null||d===void 0?void 0:d.getFieldsValue();return Array.isArray(c)?c:Object.keys(c).map(function(w){return c[w]})}return(r=h.current)===null||r===void 0?void 0:r.getFieldValue(i)};return u(u({},h.current),{},{getRowData:s,getRowsData:n,setRowData:function(r,i){var d,c,w,O;if(r==null)throw new Error("rowIndex is required");var A=L(r),ue=[e.name,(d=A==null?void 0:A.toString())!==null&&d!==void 0?d:""].flat(1).filter(Boolean),de=((c=h.current)===null||c===void 0||(w=c.getFieldsValue)===null||w===void 0?void 0:w.call(c))||{},se=q(de,ue,u(u({},s(r)),i||{}));return(O=h.current)===null||O===void 0?void 0:O.setFieldsValue(se)}})}),F.exports.useEffect(function(){!e.controlled||a.forEach(function(s,n){var t;(t=h.current)===null||t===void 0||t.setFieldsValue(be({},T(s,n),s))},{})},[a,e.controlled]),F.exports.useEffect(function(){if(e.name){var s;h.current=e==null||(s=e.editable)===null||s===void 0?void 0:s.form}},[(v=e.editable)===null||v===void 0?void 0:v.form,e.name]);var P=g||{},ee=P.record,$=P.position,ne=P.creatorButtonText,ae=P.newRecordType,te=P.parentKey,re=P.style,oe=j(P,un),M=$==="top",x=F.exports.useMemo(function(){return f&&f<=(a==null?void 0:a.length)?!1:g!==!1&&l(X,{record:p(ee,a==null?void 0:a.length,a)||{},position:$,parentKey:p(te,a==null?void 0:a.length,a),newRecordType:ae,children:l(D,u(u({type:"dashed",style:u({display:"block",margin:"10px 0",width:"100%"},re),icon:l(ge,{})},oe),{},{children:ne||R.getMessage("editableTable.action.add","\u6DFB\u52A0\u4E00\u884C\u6570\u636E")}))})},[g,f,a==null?void 0:a.length]),ie=F.exports.useMemo(function(){return x?M?{components:{header:{wrapper:function(n){var t,r=n.className,i=n.children;return E("thead",{className:r,children:[i,E("tr",{style:{position:"relative"},children:[l("td",{colSpan:0,style:{visibility:"hidden"},children:x}),l("td",{style:{position:"absolute",left:0,width:"100%"},colSpan:(t=_.columns)===null||t===void 0?void 0:t.length,children:x})]})]})}}}}:{tableViewRender:function(n,t){var r,i;return E(S,{children:[(r=(i=e.tableViewRender)===null||i===void 0?void 0:i.call(e,n,t))!==null&&r!==void 0?r:t,x]})}}:{}},[M,x]),k=u({},e.editable),le=Ce(function(s,n){var t,r,i;if((t=e.editable)===null||t===void 0||(r=t.onValuesChange)===null||r===void 0||r.call(t,s,n),(i=e.onValuesChange)===null||i===void 0||i.call(e,n,s),e.controlled){var d;e==null||(d=e.onChange)===null||d===void 0||d.call(e,n)}});return((e==null?void 0:e.onValuesChange)||((b=e.editable)===null||b===void 0?void 0:b.onValuesChange)||e.controlled&&(e==null?void 0:e.onChange))&&(k.onValuesChange=le),E(S,{children:[l(W.Provider,{value:I,children:l(on,u(u(u({search:!1,options:!1,pagination:!1,rowKey:m,revalidateOnFocus:!1},_),ie),{},{tableLayout:"fixed",actionRef:I,onChange:o,editable:u(u({},k),{},{formProps:u({formRef:h},k.formProps)}),dataSource:a,onDataSourceChange:function(n){if(Y(n),e.name&&$==="top"){var t,r=q({},[e.name].flat(1).filter(Boolean),n);(t=h.current)===null||t===void 0||t.setFieldsValue(r)}}}))}),e.name?l(ye,{name:[e.name],children:function(n){var t,r,i=Fe(n,[e.name].flat(1)),d=i==null?void 0:i.find(function(c,w){return!Re(c,N==null?void 0:N[w])});return d&&N&&(e==null||(t=e.editable)===null||t===void 0||(r=t.onValuesChange)===null||r===void 0||r.call(t,d,i)),null}}):null]})}function Z(e){var v=ce.useFormInstance();return e.name?l(U.Item,u(u({style:{maxWidth:"100%"}},e==null?void 0:e.formItemProps),{},{name:e.name,children:l(z,u(u({},e),{},{editable:u(u({},e.editable),{},{form:v})}))})):l(z,u({},e))}Z.RecordCreator=X;const dn=({dataSource:e,handleEdit:v})=>{const b={onSave:async(R,o)=>{const f=R;await v({[f]:o[f]})}};return E(S,{children:[l(Q,{dataSource:e,columns:[Be,$e,ke,Oe,De],editable:b}),l(Ne,{}),l(Q,{columns:[Ae,Ke,Se,Ge,Le,Me,...(e==null?void 0:e.genType)===tn.ZIP?[]:[je]],dataSource:e,editable:b})]})},sn=({dataSource:e,handleEdit:v,loading:b=!1})=>{const[R]=U.useForm(),[o,f]=F.exports.useState([]),g=(o==null?void 0:o.length)>0;return l(Z,{toolbar:{actions:g?[l(D,{onClick:()=>f([]),icon:l(Te,{}),children:"\u53D6\u6D88\u7F16\u8F91"},"cancelEdit"),l(D,{type:"primary",loading:b,icon:l(Pe,{}),onClick:async()=>{const m=await R.validateFields();await v({columns:Object.keys(m).map(C=>({...m[C],columnId:Number(C)}))}),f([])},children:"\u4FDD\u5B58"},"edit")]:[l(D,{icon:l(Ie,{}),type:"primary",onClick:()=>{e&&f(e==null?void 0:e.map(m=>{var C,y;return(y=(C=m==null?void 0:m.columnId)==null?void 0:C.toString())!=null?y:""}))},children:"\u7F16\u8F91"},"edit")]},rowKey:"columnId",ghost:!0,size:"small",scroll:{x:"max-content"},columns:[qe,pe,He,Qe,ze,Je,Ue,We,Xe,Ze,Ye,en],value:e,recordCreatorProps:!1,editable:{form:R,editableKeys:o}})},J={BASE_INFO:"\u57FA\u672C\u4FE1\u606F",FIELD_INFO:"\u5B57\u6BB5\u4FE1\u606F"},Pn=()=>{var C;const e=Ee(),v=Number((C=e==null?void 0:e.tableId)!=null?C:"0"),[b,R]=F.exports.useState("BASE_INFO"),{data:o,refresh:f}=_e(async()=>await nn({tableId:v}),{ready:v>0,refreshDeps:[v]}),{mutateAsync:g,isLoading:m}=rn(async y=>{await an({tableId:v,businessName:o.info.businessName,functionName:o.info.functionName,className:o.info.className,functionAuthor:o.info.functionAuthor,moduleName:o.info.moduleName,packageName:o.info.packageName,tableComment:o.info.tableComment,tableName:o.info.tableName,columns:o.rows,...y})},{onSuccess:()=>{f(),xe.success("\u4FDD\u5B58\u6210\u529F")}});return l(Ve,{children:E(K,{tabs:{activeKey:b,onChange:y=>{R(y)}},children:[l(K.TabPane,{tab:J.BASE_INFO,children:l(dn,{dataSource:o==null?void 0:o.info,handleEdit:g})},"BASE_INFO"),l(K.TabPane,{tab:J.FIELD_INFO,children:l(sn,{dataSource:o==null?void 0:o.rows,handleEdit:g,loading:m})},"FIELD_INFO")]})})};export{Pn as default};
