import{aD as X,ac as Y,a as e,b8 as Z,ab as $,n as _,l as ee,r as h,q as w,j as i,aA as g,b9 as te,ba as L,aH as se,aL as E,bb as ae,aJ as A,bc as re,F as B,bd as ue,be as oe,bf as R,b4 as b,aI as v,bg as ne,bh as le,bi as ce,bj as ie,bk as de,bl as T,az as pe,b5 as P}from"./index.7e2e4aff.js";import{B as me}from"./index.0dac2af8.js";import{A as k}from"./index.3efbd4c1.js";import{P as De}from"./index.40385f79.js";import{u as Ee,E as q,a as S}from"./useMutation.esm.c7490ab8.js";import{b as I}from"./keepAlive.a2f6a073.js";import{S as O,a as he,b as Fe,c as fe,d as be}from"./SysDeptService.a919a020.js";import{p as j}from"./tree.1fecacac.js";import{a as Pe,u as ye}from"./utils.81244b9b.js";import{u as W}from"./useQuery.esm.3039810b.js";import{u as Se}from"./index.b95225a0.js";import{C as ge,a as Ae,b as Be}from"./common.026964d1.js";import{E as M}from"./index.37f2e67b.js";import{u as Ie}from"./useRequest.366cd4a8.js";import"./utils.esm.6214005e.js";import"./cloneDeep.5079a371.js";var Ce=["fieldProps","request","params","proFieldProps"],Ne=function(s,o){var r=s.fieldProps,a=s.request,n=s.params,u=s.proFieldProps,l=Y(s,Ce);return e(Z,$({valueType:"treeSelect",fieldProps:r,ref:o,request:a,params:n,filedConfig:{customLightMode:!0},proFieldProps:u},l))},xe=X.forwardRef(Ne);const Q="systemDept",C=Pe({open:!1,deptId:0,deptName:""}),V=()=>_(C),ve=()=>{const t=ee(C);return(s,o)=>{t({open:!0,deptId:s,deptName:o})}},Te=()=>ye(C),K=[Q,"list"],we=(t,s)=>{const o=W(K,async()=>{const r=await O(t),a=j(r,{id:"deptId",pId:"parentId",rootPId:null});return{map:r.reduce((n,u)=>n.set(u.deptId,u),new Map),treeData:a,allParentIds:Array.from(r.reduce((n,u)=>n.add(u.parentId),new Set))}},{onSuccess:r=>{s.onSuccess(r.allParentIds)}});return h.exports.useEffect(()=>{o.refetch()},[t]),o},z=()=>{const t=w();return()=>t.invalidateQueries(K)},G=[Q,"options"],H=()=>W(G,async()=>{const t=await O({});return j(t,{id:"deptId",pId:"parentId",rootPId:null})}),J=()=>{const t=w();return()=>t.invalidateQueries(G)},Le=()=>{const t=I(),s=h.exports.useRef(),[o,{toggle:r}]=Se(),{data:a,refetch:n}=H(),{mutate:u,isLoading:l}=Ee(async()=>{var p;const d=await((p=s.current)==null?void 0:p.validateFields());await he(d)},{onSuccess:()=>{var d;A.success("\u65B0\u5EFA\u6210\u529F"),n(),r(),(d=s.current)==null||d.resetFields()}});return i(k,{accessible:t.canAddSysDept,children:[e(g,{type:"primary",icon:e(te,{}),onClick:r,children:"\u65B0\u5EFA"}),e(L,{title:"\u65B0\u5EFA\u90E8\u95E8",okText:"\u63D0\u4EA4",open:o,onCancel:r,onOk:()=>u(),okButtonProps:{loading:l},children:i(se,{submitter:!1,formRef:s,grid:!0,rowProps:{gutter:[16,0]},children:[e(xe,{name:"parentId",label:"\u4E0A\u7EA7\u90E8\u95E8",rules:[{required:!0,message:"\u8BF7\u9009\u62E9\u4E0A\u7EA7\u90E8\u95E8"}],fieldProps:{treeData:a!=null?a:[],fieldNames:{label:"deptName",value:"deptId"}}}),e(E,{name:"deptName",label:"\u90E8\u95E8\u540D\u79F0",rules:[{required:!0}],colProps:{span:12}}),e(De,{name:"orderNum",label:"\u663E\u793A\u6392\u5E8F",initialValue:0,rules:[{required:!0}],colProps:{span:12}}),e(E,{name:"leader",label:"\u8D1F\u8D23\u4EBA",colProps:{span:12}}),e(E,{name:"phone",label:"\u8054\u7CFB\u7535\u8BDD",colProps:{span:12}}),e(E,{name:"email",label:"\u90AE\u7BB1",colProps:{span:12}}),e(ae.Group,{name:"status",label:"\u72B6\u6001",valueEnum:q,initialValue:S.ENABLE,colProps:{span:12}})]})})]})},Re=()=>{const t=I(),{deptId:s,deptName:o,open:r}=V(),a=Te(),n=z(),u=J(),l=()=>{L.confirm({title:"\u5220\u9664\u786E\u8BA4",content:i(B,{children:["\u786E\u5B9A\u5220\u9664\u90E8\u95E8",e(ue.Text,{code:!0,children:o}),"\u5417\uFF1F"]}),onOk:async()=>{await Fe({deptId:s}),A.success("\u5220\u9664\u6210\u529F"),a(),n(),u()}})};return e(k,{accessible:r&&t.canRemoveSysDept,children:e(g,{danger:!0,ghost:!0,icon:e(re,{}),onClick:l,children:"\u5220\u9664"})})},ke={title:"\u90E8\u95E8\u540D\u79F0",dataIndex:"deptName",key:"deptName",valueType:"text"},qe={title:"\u8D1F\u8D23\u4EBA",dataIndex:"leader",key:"leader",valueType:"text"},Oe={title:"\u8054\u7CFB\u7535\u8BDD",dataIndex:"phone",key:"phone",valueType:"text"},je={title:"\u90AE\u7BB1",dataIndex:"email",key:"email",valueType:"text"},We=(t=[])=>({title:"\u4E0A\u7EA7\u90E8\u95E8",dataIndex:"parentId",key:"parentId",valueType:"treeSelect",fieldProps:{treeData:t,dropdownMatchSelectWidth:250,fieldNames:{label:"deptName",value:"deptId"}}}),y={xs:1,sm:1,md:1,lg:1,xl:2},Me=()=>{const[t,s]=h.exports.useState([]),o=I(),[r]=oe.useForm(),a=z(),n=J(),{deptId:u,open:l}=V(),{data:d}=H(),p=We(d),{data:m,loading:F,refresh:U}=Ie(async()=>{var x;const{ancestors:c,...D}=await fe({deptId:u}),N=(x=c==null?void 0:c.split(","))!=null?x:[];return{...D,ancestors:Number(N[N.length-1])}},{ready:l&&u>0,refreshDeps:[u],onSuccess:()=>{s([])}}),f=o!=null&&o.canEditSysDept?{form:r,editableKeys:t,onChange:(c,D)=>{s(c),c.length===1&&!Array.isArray(D)&&r.setFieldsValue({[c[0]]:D[c[0]]})},onSave:async(c,D)=>{await be({deptId:u,deptName:m.deptName,orderNum:m.orderNum,parentId:0,[c]:D[c]}),A.success("\u4FDD\u5B58\u6210\u529F"),U(),a(),n()}}:void 0;return l?i(R,{spinning:F,children:[e(b,{column:y,editable:f,dataSource:m,columns:[ge,Ae,Be]}),e(v,{}),e(b,{column:y,editable:f,dataSource:m,columns:[ke,p]}),e(v,{}),e(b,{column:y,editable:f,dataSource:m,columns:[qe,Oe,je]})]}):e(M,{description:"\u70B9\u51FB\u9009\u62E9\u5DE6\u4FA7\u90E8\u95E8\u9879\u67E5\u770B\u8BE6\u60C5"})},Qe=t=>i(B,{children:[e(T,{color:"rgb(148 163 184)",children:t.orderNum}),i(pe,{children:[t.deptName,e(T,{color:t.status===S.ENABLE?"success":"error",children:t.status===S.ENABLE?"\u542F\u7528\u4E2D":"\u5DF2\u7981\u7528"})]})]}),Ve=()=>{var d;const[t,s]=h.exports.useState([]),[o,r]=h.exports.useState({}),{data:a,isFetching:n}=we(o,{onSuccess:p=>{s(p)}}),u=ve(),l=(t==null?void 0:t.length)!==0&&(t==null?void 0:t.length)===((d=a==null?void 0:a.allParentIds)==null?void 0:d.length);return i(B,{children:[i("div",{className:"flex justify-between items-center",children:[e(g,{size:"small",className:"my-2",icon:l?e(ne,{}):e(le,{}),onClick:()=>s(l?[]:a==null?void 0:a.allParentIds),children:l?"\u5168\u90E8\u6298\u53E0":"\u5168\u90E8\u5C55\u5F00"}),i(ce,{onFinish:async p=>r(p),children:[e(E,{name:"deptName",label:"\u90E8\u95E8\u540D\u79F0"}),e(ie,{name:"status",label:"\u72B6\u6001",valueEnum:q})]})]}),a!=null&&a.treeData?e(R,{spinning:n,children:e("div",{className:"h-[calc(100vh-270px)]",children:e(de,{blockNode:!0,showLine:{showLeafIcon:!1},titleRender:Qe,treeData:a.treeData,expandedKeys:t,onExpand:s,fieldNames:{title:"deptName",key:"deptId"},onSelect:(p,{selected:m,node:{key:F}})=>{!m||u(F,a.map.get(F).deptName)}})})}):e(M,{})]})},ut=()=>e(me,{children:i(P,{ghost:!0,gutter:24,children:[e(P,{title:"\u90E8\u95E8\u5217\u8868",colSpan:"500px",extra:e(Le,{}),children:e(Ve,{})}),e(P,{title:"\u90E8\u95E8\u8BE6\u60C5",extra:e(Re,{}),children:e(Me,{})})]})});export{ut as default};
