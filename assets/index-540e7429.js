import{a as u,r as T,e as j,j as p,F as $}from"./jsx-runtime-06f68cbc.js";import{aI as ce,_ as d,aC as W,aH as se,b as K,ck as ve,k as me,h as fe,cl as L,e as he,aF as q,Y as V,cm as ye,cn as ge,ca as be,bW as Te,b6 as xe,co as Ce,x as Ie,y as G,aJ as ke,an as we,cd as Ne,b5 as Re,bV as Ee,ay as Fe,aU as pe,ag as Pe}from"./index-37fcb888.js";import{T as Ve,G as _e,J as Ae,Q as Be}from"./index-e338c608.js";import{P as J}from"./index-4f7a74e8.js";import{f as Se}from"./index-e664d339.js";import{g as De,a as $e}from"./Tool-6d10c736.js";import{u as je}from"./useRequest-d8c32193.js";import{u as Oe}from"./useMutation-a5a4d775.js";import"./index-92527557.js";import"./Skeleton-9c00c7cd.js";import"./react-27f57fd0.js";import"./index-6f927546.js";import"./mutation-9ec6c65f.js";var Me=["onTableChange","maxLength","formItemProps","recordCreatorProps","rowKey","controlled","defaultValue","onChange","editableFormRef"],Ke=["record","position","creatorButtonText","newRecordType","parentKey","style"],Y=j.createContext(void 0);function z(e){var i=e.children,h=e.record,x=e.position,r=e.newRecordType,m=e.parentKey,y=T.useContext(Y);return j.cloneElement(i,d(d({},i.props),{},{onClick:function(){var b=Ie(G().mark(function k(E){var I,R,f,P;return G().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(I=(R=i.props).onClick)===null||I===void 0?void 0:I.call(R,E);case 2:if(P=a.sent,P!==!1){a.next=5;break}return a.abrupt("return");case 5:y==null||(f=y.current)===null||f===void 0||f.addEditRecord(h,{position:x,newRecordType:r,parentKey:m});case 6:case"end":return a.stop()}},k)}));function g(k){return b.apply(this,arguments)}return g}()}))}function Q(e){var i,h,x=se(),r=e.onTableChange,m=e.maxLength;e.formItemProps;var y=e.recordCreatorProps,b=e.rowKey;e.controlled;var g=e.defaultValue;e.onChange;var k=e.editableFormRef,E=K(e,Me),I=ve(e.value),R=T.useRef(),f=T.useRef();T.useImperativeHandle(E.actionRef,function(){return R.current});var P=me(function(){return e.value||g||[]},{value:e.value,onChange:e.onChange}),_=fe(P,2),a=_[0],Z=_[1],w=j.useMemo(function(){return typeof b=="function"?b:function(s,t){return s[b]||t}},[b]),O=function(t){if(typeof t=="number"&&!e.name){if(t>=a.length)return t;var n=a&&a[t];return w==null?void 0:w(n,t)}if((typeof t=="string"||t>=a.length)&&e.name){var l=a.findIndex(function(o,c){var v;return(w==null||(v=w(o,c))===null||v===void 0?void 0:v.toString())===(t==null?void 0:t.toString())});return l}return t};T.useImperativeHandle(k,function(){var s=function(l){var o,c;if(l==null)throw new Error("rowIndex is required");var v=O(l),C=[e.name,(o=v==null?void 0:v.toString())!==null&&o!==void 0?o:""].flat(1).filter(Boolean);return(c=f.current)===null||c===void 0?void 0:c.getFieldValue(C)},t=function(){var l,o=[e.name].flat(1).filter(Boolean);if(Array.isArray(o)&&o.length===0){var c,v=(c=f.current)===null||c===void 0?void 0:c.getFieldsValue();return Array.isArray(v)?v:Object.keys(v).map(function(C){return v[C]})}return(l=f.current)===null||l===void 0?void 0:l.getFieldValue(o)};return d(d({},f.current),{},{getRowData:s,getRowsData:t,setRowData:function(l,o){var c,v,C,S;if(l==null)throw new Error("rowIndex is required");var D=O(l),oe=[e.name,(c=D==null?void 0:D.toString())!==null&&c!==void 0?c:""].flat(1).filter(Boolean),ue=((v=f.current)===null||v===void 0||(C=v.getFieldsValue)===null||C===void 0?void 0:C.call(v))||{},de=L(ue,oe,d(d({},s(l)),o||{}));return(S=f.current)===null||S===void 0||S.setFieldsValue(de),!0}})}),T.useEffect(function(){e.controlled&&a.forEach(function(s,t){var n;(n=f.current)===null||n===void 0||n.setFieldsValue(he({},w(s,t),s))},{})},[a,e.controlled]),T.useEffect(function(){if(e.name){var s;f.current=e==null||(s=e.editable)===null||s===void 0?void 0:s.form}},[(i=e.editable)===null||i===void 0?void 0:i.form,e.name]);var N=y||{},X=N.record,A=N.position,ee=N.creatorButtonText,te=N.newRecordType,ae=N.parentKey,ne=N.style,le=K(N,Ke),M=A==="top",F=T.useMemo(function(){return m&&m<=(a==null?void 0:a.length)?!1:y!==!1&&u(z,{record:q(X,a==null?void 0:a.length,a)||{},position:A,parentKey:q(ae,a==null?void 0:a.length,a),newRecordType:te,children:u(V,d(d({type:"dashed",style:d({display:"block",margin:"10px 0",width:"100%"},ne),icon:u(ye,{})},le),{},{children:ee||x.getMessage("editableTable.action.add","添加一行数据")}))})},[y,m,a==null?void 0:a.length]),ie=T.useMemo(function(){return F?M?{components:{header:{wrapper:function(t){var n,l=t.className,o=t.children;return p("thead",{className:l,children:[o,p("tr",{style:{position:"relative"},children:[u("td",{colSpan:0,style:{visibility:"hidden"},children:F}),u("td",{style:{position:"absolute",left:0,width:"100%"},colSpan:(n=E.columns)===null||n===void 0?void 0:n.length,children:F})]})]})}}}}:{tableViewRender:function(t,n){var l,o;return p($,{children:[(l=(o=e.tableViewRender)===null||o===void 0?void 0:o.call(e,t,n))!==null&&l!==void 0?l:n,F]})}}:{}},[M,F]),B=d({},e.editable),re=ge(function(s,t){var n,l,o;if((n=e.editable)===null||n===void 0||(l=n.onValuesChange)===null||l===void 0||l.call(n,s,t),(o=e.onValuesChange)===null||o===void 0||o.call(e,t,s),e.controlled){var c;e==null||(c=e.onChange)===null||c===void 0||c.call(e,t)}});return(e!=null&&e.onValuesChange||(h=e.editable)!==null&&h!==void 0&&h.onValuesChange||e.controlled&&e!==null&&e!==void 0&&e.onChange)&&(B.onValuesChange=re),p($,{children:[u(Y.Provider,{value:R,children:u(be,d(d(d({search:!1,options:!1,pagination:!1,rowKey:b,revalidateOnFocus:!1},E),ie),{},{tableLayout:"fixed",actionRef:R,onChange:r,editable:d(d({},B),{},{formProps:d({formRef:f},B.formProps)}),dataSource:a,onDataSourceChange:function(t){if(Z(t),e.name&&A==="top"){var n,l=L({},[e.name].flat(1).filter(Boolean),t);(n=f.current)===null||n===void 0||n.setFieldsValue(l)}}}))}),e.name?u(Te,{name:[e.name],children:function(t){var n,l,o=xe(t,[e.name].flat(1)),c=o==null?void 0:o.find(function(v,C){return!Ce(v,I==null?void 0:I[C])});return c&&I&&(e==null||(n=e.editable)===null||n===void 0||(l=n.onValuesChange)===null||l===void 0||l.call(n,c,o)),null}}):null]})}function U(e){var i=ce.useFormInstance();return e.name?u(W.Item,d(d({style:{maxWidth:"100%"}},e==null?void 0:e.formItemProps),{},{name:e.name,children:u(Q,d(d({},e),{},{editable:d(d({},e.editable),{},{form:i})}))})):u(Q,d({},e))}U.RecordCreator=z;globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,i){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,i),i)}};const Le=({dataSource:e,handleEdit:i})=>{const h={onSave:async(x,r)=>{const m=x;await i({[m]:r[m]})}};return p($,{children:[u(J,{dataSource:e,columns:[{title:"表名称",dataIndex:"tableName",key:"tableName",valueType:"text"},{title:"表描述",dataIndex:"tableComment",key:"tableComment",valueType:"text"},{title:"实体名称",dataIndex:"className",key:"className",valueType:"text",hideInSearch:!0},{title:"作者",dataIndex:"functionAuthor",key:"functionAuthor",valueType:"text"},{title:"备注",dataIndex:"remark",key:"remark",valueType:"textarea",hideInSearch:!0}],editable:h}),u(ke,{}),u(J,{columns:[{title:"生成模版",dataIndex:"tplCategory",key:"tplCategory",valueType:"select",valueEnum:Ve},{title:"生成包路径",dataIndex:"packageName",key:"packageName",valueType:"text"},{title:"生成模块名",dataIndex:"moduleName",key:"moduleName",valueType:"text"},{title:"生成业务名",dataIndex:"businessName",key:"businessName",valueType:"text"},{title:"生成功能名",dataIndex:"functionName",key:"functionName",valueType:"text"},{title:"生成代码方式",dataIndex:"genType",key:"genType",valueType:"select",valueEnum:_e},...(e==null?void 0:e.genType)==="ZIP"?[]:[{title:"自定义路径",dataIndex:"genPath",key:"genPath",valueType:"text"}]],dataSource:e,editable:h})]})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,i){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,i),i)}};const qe=()=>{const{valueEnumSysYesNo:e}=Se();return[{title:"序号",dataIndex:"sort",valueType:"indexBorder",editable:!1},{title:"字段名称",dataIndex:"columnName",key:"columnName",valueType:"text",editable:!1,ellipsis:!0},{title:"字段描述",dataIndex:"columnComment",key:"columnComment",valueType:"text"},{title:"物理类型",dataIndex:"columnType",key:"columnType",valueType:"text",editable:!1,ellipsis:!0},{title:"JAVA类型",dataIndex:"javaType",key:"javaType",valueType:"select",valueEnum:Ae},{title:"JAVA属性",dataIndex:"javaField",key:"javaField",valueType:"text"},{title:"插入",dataIndex:"isInsert",key:"isInsert",valueType:"radioButton",valueEnum:e},{title:"编辑",dataIndex:"isEdit",key:"isEdit",valueType:"radioButton",valueEnum:e},{title:"列表",dataIndex:"isList",key:"isList",valueType:"radioButton",valueEnum:e},{title:"查询",dataIndex:"isQuery",key:"isQuery",valueType:"radioButton",valueEnum:e},{title:"必填",dataIndex:"isRequired",key:"isRequired",valueType:"radioButton",valueEnum:e},{title:"查询方式",dataIndex:"queryType",key:"queryType",valueType:"select",valueEnum:Be}]},Ge=({dataSource:e,handleEdit:i,loading:h=!1})=>{const[x]=W.useForm(),[r,m]=T.useState([]),y=(r==null?void 0:r.length)>0,b=qe();return u(U,{toolbar:{actions:y?[u(V,{onClick:()=>m([]),icon:u(we,{}),children:"取消编辑"},"cancelEdit"),u(V,{type:"primary",loading:h,icon:u(Ne,{}),onClick:async()=>{const g=await x.validateFields();await i({columns:Object.keys(g).map(k=>({...g[k],columnId:Number(k)}))}),m([])},children:"保存"},"edit")]:[u(V,{icon:u(Re,{}),type:"primary",onClick:()=>{m(e.map(g=>g.columnId.toString()))},children:"编辑"},"edit")]},rowKey:"columnId",ghost:!0,size:"small",scroll:{x:"max-content"},columns:b,value:e,recordCreatorProps:!1,editable:{form:x,editableKeys:r}})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,i){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,i),i)}};const H={BASE_INFO:"基本信息",FIELD_INFO:"字段信息"},lt=()=>{const e=Ee(),i=Number((e==null?void 0:e.tableId)??"0"),[h,x]=T.useState("BASE_INFO"),{data:r,refresh:m}=je(()=>De({tableId:i}),{ready:i>0,refreshDeps:[i]}),{mutateAsync:y,isLoading:b}=Oe(async g=>{await $e({tableId:i,businessName:r.info.businessName,functionName:r.info.functionName,className:r.info.className,functionAuthor:r.info.functionAuthor,moduleName:r.info.moduleName,packageName:r.info.packageName,tableComment:r.info.tableComment,tableName:r.info.tableName,columns:r.rows,...g})},{onSuccess:()=>{m(),Pe.success("保存成功")}});return u(Fe,{children:u(pe,{tabs:{items:[{label:H.BASE_INFO,key:"BASE_INFO",children:u(Le,{dataSource:r==null?void 0:r.info,handleEdit:y})},{label:H.FIELD_INFO,key:"FIELD_INFO",children:u(Ge,{dataSource:r==null?void 0:r.rows,handleEdit:y,loading:b})}],activeKey:h,onChange:g=>{x(g)}}})})};export{lt as default};
