import{o as se,j as u,d,F as H,r as x,e as $,l as ce,a as M,de as ve,da as me,_ as fe,df as L,k as ye,i as Q,f as P,bU as he,b as A,p as j,dg as ge,cc as be,bc as Te,dh as xe,di as Ce,g as Ie,h as q,dj as ke,dk as we,aJ as Ee,D as Ne,bq as Re,cp as Fe,a3 as Ae,bV as pe,ar as Pe,dl as Se,dm as Ve,b3 as _e,A as De,B as Be,Q as je}from"./index-8e79839f.js";import{P as G}from"./index-e1d81cf8.js";import{g as $e,a as Oe}from"./Tool-3ddf3ff2.js";import{u as Ke}from"./useRequest-39bbbc00.js";import{u as Me}from"./useMutation-25c2b1ea.js";var Le=["onTableChange","maxLength","formItemProps","recordCreatorProps","rowKey","controlled","defaultValue","onChange","editableFormRef"],Qe=["record","position","creatorButtonText","newRecordType","parentKey","style"],Y=$.createContext(void 0);function z(e){var n=e.children,y=e.record,C=e.position,b=e.newRecordType,i=e.parentKey,h=x.useContext(Y);return $.cloneElement(n,d(d({},n.props),{},{onClick:function(){var m=Ie(q().mark(function T(R){var k,N,f,p;return q().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(k=(N=n.props).onClick)===null||k===void 0?void 0:k.call(N,R);case 2:if(p=a.sent,p!==!1){a.next=5;break}return a.abrupt("return");case 5:h==null||(f=h.current)===null||f===void 0||f.addEditRecord(y,{position:C,newRecordType:b,parentKey:i});case 6:case"end":return a.stop()}},T)}));function g(T){return m.apply(this,arguments)}return g}()}))}function J(e){var n,y,C=ce(),b=e.onTableChange,i=e.maxLength;e.formItemProps;var h=e.recordCreatorProps,m=e.rowKey;e.controlled;var g=e.defaultValue;e.onChange;var T=e.editableFormRef,R=M(e,Le),k=ve(e.value),N=x.useRef(),f=x.useRef();x.useImperativeHandle(R.actionRef,function(){return N.current});var p=me(function(){return e.value||g||[]},{value:e.value,onChange:e.onChange}),S=fe(p,2),a=S[0],Z=S[1],w=$.useMemo(function(){return typeof m=="function"?m:function(c,t){return c[m]||t}},[m]),O=function(t){if(typeof t=="number"&&!e.name){if(t>=a.length)return t;var l=a&&a[t];return w==null?void 0:w(l,t)}if((typeof t=="string"||t>=a.length)&&e.name){var r=a.findIndex(function(o,s){var v;return(w==null||(v=w(o,s))===null||v===void 0?void 0:v.toString())===(t==null?void 0:t.toString())});return r}return t};x.useImperativeHandle(T,function(){var c=function(r){var o,s;if(r==null)throw new Error("rowIndex is required");var v=O(r),I=[e.name,(o=v==null?void 0:v.toString())!==null&&o!==void 0?o:""].flat(1).filter(Boolean);return(s=f.current)===null||s===void 0?void 0:s.getFieldValue(I)},t=function(){var r,o=[e.name].flat(1).filter(Boolean);if(Array.isArray(o)&&o.length===0){var s,v=(s=f.current)===null||s===void 0?void 0:s.getFieldsValue();return Array.isArray(v)?v:Object.keys(v).map(function(I){return v[I]})}return(r=f.current)===null||r===void 0?void 0:r.getFieldValue(o)};return d(d({},f.current),{},{getRowData:c,getRowsData:t,setRowData:function(r,o){var s,v,I,D;if(r==null)throw new Error("rowIndex is required");var B=O(r),oe=[e.name,(s=B==null?void 0:B.toString())!==null&&s!==void 0?s:""].flat(1).filter(Boolean),ue=((v=f.current)===null||v===void 0||(I=v.getFieldsValue)===null||I===void 0?void 0:I.call(v))||{},de=L(ue,oe,d(d({},c(r)),o||{}));return(D=f.current)===null||D===void 0||D.setFieldsValue(de),!0}})}),x.useEffect(function(){e.controlled&&a.forEach(function(c,t){var l;(l=f.current)===null||l===void 0||l.setFieldsValue(ye({},w(c,t),c))},{})},[a,e.controlled]),x.useEffect(function(){if(e.name){var c;f.current=e==null||(c=e.editable)===null||c===void 0?void 0:c.form}},[(n=e.editable)===null||n===void 0?void 0:n.form,e.name]);var E=h||{},X=E.record,V=E.position,ee=E.creatorButtonText,te=E.newRecordType,ae=E.parentKey,ne=E.style,le=M(E,Qe),K=V==="top",F=x.useMemo(function(){return i&&i<=(a==null?void 0:a.length)?!1:h!==!1&&u(z,{record:Q(X,a==null?void 0:a.length,a)||{},position:V,parentKey:Q(ae,a==null?void 0:a.length,a),newRecordType:te,children:u(P,d(d({type:"dashed",style:d({display:"block",margin:"10px 0",width:"100%"},ne),icon:u(he,{})},le),{},{children:ee||C.getMessage("editableTable.action.add","添加一行数据")}))})},[h,i,a==null?void 0:a.length]),ie=x.useMemo(function(){return F?K?{components:{header:{wrapper:function(t){var l,r=t.className,o=t.children;return A("thead",{className:r,children:[o,A("tr",{style:{position:"relative"},children:[u("td",{colSpan:0,style:{visibility:"hidden"},children:F}),u("td",{style:{position:"absolute",left:0,width:"100%"},colSpan:(l=R.columns)===null||l===void 0?void 0:l.length,children:F})]})]})}}}}:{tableViewRender:function(t,l){var r,o;return A(j,{children:[(r=(o=e.tableViewRender)===null||o===void 0?void 0:o.call(e,t,l))!==null&&r!==void 0?r:l,F]})}}:{}},[K,F]),_=d({},e.editable),re=ge(function(c,t){var l,r,o;if((l=e.editable)===null||l===void 0||(r=l.onValuesChange)===null||r===void 0||r.call(l,c,t),(o=e.onValuesChange)===null||o===void 0||o.call(e,t,c),e.controlled){var s;e==null||(s=e.onChange)===null||s===void 0||s.call(e,t)}});return(e!=null&&e.onValuesChange||(y=e.editable)!==null&&y!==void 0&&y.onValuesChange||e.controlled&&e!==null&&e!==void 0&&e.onChange)&&(_.onValuesChange=re),A(j,{children:[u(Y.Provider,{value:N,children:u(be,d(d(d({search:!1,options:!1,pagination:!1,rowKey:m,revalidateOnFocus:!1},R),ie),{},{tableLayout:"fixed",actionRef:N,onChange:b,editable:d(d({},_),{},{formProps:d({formRef:f},_.formProps)}),dataSource:a,onDataSourceChange:function(t){if(Z(t),e.name&&V==="top"){var l,r=L({},[e.name].flat(1).filter(Boolean),t);(l=f.current)===null||l===void 0||l.setFieldsValue(r)}}}))}),e.name?u(Te,{name:[e.name],children:function(t){var l,r,o=xe(t,[e.name].flat(1)),s=o==null?void 0:o.find(function(v,I){return!Ce(v,k==null?void 0:k[I])});return s&&k&&(e==null||(l=e.editable)===null||l===void 0||(r=l.onValuesChange)===null||r===void 0||r.call(l,s,o)),null}}):null]})}function U(e){var n=se.useFormInstance();return e.name?u(H.Item,d(d({style:{maxWidth:"100%"}},e==null?void 0:e.formItemProps),{},{name:e.name,children:u(J,d(d({},e),{},{editable:d(d({},e.editable),{},{form:n})}))})):u(J,d({},e))}U.RecordCreator=z;globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,n){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,n),n)}};const qe=({dataSource:e,handleEdit:n})=>{const{valueEnumSysGenType:y}=ke(),{valueEnumSysTplCategory:C}=we(),i=Ee()("tool:gen:edit")?{onSave:async(h,m)=>{const g=h;await n({[g]:m[g]})}}:void 0;return A(j,{children:[u(G,{dataSource:e,columns:[{title:"表名称",dataIndex:"tableName",key:"tableName",valueType:"text"},{title:"表描述",dataIndex:"tableComment",key:"tableComment",valueType:"text"},{title:"实体名称",dataIndex:"className",key:"className",valueType:"text",hideInSearch:!0},{title:"作者",dataIndex:"functionAuthor",key:"functionAuthor",valueType:"text"},{title:"备注",dataIndex:"remark",key:"remark",valueType:"textarea",hideInSearch:!0}],editable:i}),u(Ne,{}),u(G,{columns:[{title:"生成模版",dataIndex:"tplCategory",key:"tplCategory",valueType:"select",valueEnum:C},{title:"生成包路径",dataIndex:"packageName",key:"packageName",valueType:"text"},{title:"生成模块名",dataIndex:"moduleName",key:"moduleName",valueType:"text"},{title:"生成业务名",dataIndex:"businessName",key:"businessName",valueType:"text"},{title:"生成功能名",dataIndex:"functionName",key:"functionName",valueType:"text"},{title:"生成代码方式",dataIndex:"genType",key:"genType",valueType:"select",valueEnum:y},...(e==null?void 0:e.genType)==="ZIP"?[]:[{title:"自定义路径",dataIndex:"genPath",key:"genPath",valueType:"text"}]],dataSource:e,editable:i})]})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,n){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,n),n)}};const Ge=()=>{const{valueEnumSysYesNo:e}=Pe(),{valueEnumSysQueryType:n}=Se(),{valueEnumSysJavaType:y}=Ve();return[{title:"序号",dataIndex:"sort",valueType:"indexBorder",editable:!1},{title:"字段名称",dataIndex:"columnName",key:"columnName",valueType:"text",editable:!1,ellipsis:!0},{title:"字段描述",dataIndex:"columnComment",key:"columnComment",valueType:"text"},{title:"物理类型",dataIndex:"columnType",key:"columnType",valueType:"text",editable:!1,ellipsis:!0},{title:"JAVA类型",dataIndex:"javaType",key:"javaType",valueType:"select",valueEnum:y},{title:"JAVA属性",dataIndex:"javaField",key:"javaField",valueType:"text"},{title:"插入",dataIndex:"isInsert",key:"isInsert",valueType:"radioButton",valueEnum:e},{title:"编辑",dataIndex:"isEdit",key:"isEdit",valueType:"radioButton",valueEnum:e},{title:"列表",dataIndex:"isList",key:"isList",valueType:"radioButton",valueEnum:e},{title:"查询",dataIndex:"isQuery",key:"isQuery",valueType:"radioButton",valueEnum:e},{title:"必填",dataIndex:"isRequired",key:"isRequired",valueType:"radioButton",valueEnum:e},{title:"查询方式",dataIndex:"queryType",key:"queryType",valueType:"select",valueEnum:n}]},Je=({dataSource:e,handleEdit:n,loading:y=!1})=>{const[C]=H.useForm(),[b,i]=x.useState([]),h=(b==null?void 0:b.length)>0,m=Ge();return u(U,{toolbar:{actions:h?[u(P,{onClick:()=>i([]),icon:u(Re,{}),children:"取消编辑"},"cancelEdit"),u(P,{type:"primary",loading:y,icon:u(Fe,{}),onClick:async()=>{const g=await C.validateFields();await n({columns:Object.keys(g).map(T=>({...g[T],columnId:Number(T)}))}),i([])},children:"保存"},"edit")]:[u(Ae,{accessKey:"tool:gen:edit",children:u(P,{icon:u(pe,{}),type:"primary",onClick:()=>{i(e.map(g=>g.columnId.toString()))},children:"编辑"})},"edit")]},rowKey:"columnId",ghost:!0,size:"small",scroll:{x:"max-content"},columns:m,value:e,recordCreatorProps:!1,editable:{form:C,editableKeys:b}})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(e,n){return this.cache.has(e)?this.cache.get(e):(this.cache.set(e,n),n)}};const W={BASE_INFO:"基本信息",FIELD_INFO:"字段信息"},Ze=()=>{const e=_e(),n=Number((e==null?void 0:e.tableId)??"0"),{message:y}=De.useApp(),[C,b]=x.useState("BASE_INFO"),{data:i,refresh:h}=Ke(()=>$e({tableId:n}),{ready:n>0,refreshDeps:[n]}),{mutateAsync:m,isLoading:g}=Me(async T=>{await Oe({tableId:n,businessName:i.info.businessName,functionName:i.info.functionName,className:i.info.className,functionAuthor:i.info.functionAuthor,moduleName:i.info.moduleName,packageName:i.info.packageName,tableComment:i.info.tableComment,tableName:i.info.tableName,columns:i.rows,...T})},{onSuccess:()=>{h(),y.success("保存成功")}});return u(Be,{children:u(je,{tabs:{items:[{label:W.BASE_INFO,key:"BASE_INFO",children:u(qe,{dataSource:i==null?void 0:i.info,handleEdit:m})},{label:W.FIELD_INFO,key:"FIELD_INFO",children:u(Je,{dataSource:i==null?void 0:i.rows,handleEdit:m,loading:g})}],activeKey:C,onChange:T=>{b(T)}}})})};export{Ze as default};
